<!--NOTE1: Parts of the D3 and HTML sections were based in the "d3.html" file 
available in the course notes -->
<!--NOTE2: Parts of the CSS and HTML sections were based in the "Reverted" 
template of Bryant Smith, available in the following link
Link: https://www.bryantsmith.com/template/ -->

<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="style.css?ck" />
    <!--NOTE: I learned to put the LinkedIn, GitHub and mail logos in these posts of 
    w3Schools, the logos are from Cloudflare
    Link1: https://www.w3schools.com/icons/tryit.asp?filename=tryicons_fa-linkedin-square 
    Link2: https://www.w3schools.com/icons/tryit.asp?filename=tryicons_fa-github
    Link3: https://www.w3schools.com/icons/tryit.asp?filename=tryicons_fa-envelope -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  </head>

  <body>

    <!-- Add navigation bar -->
    <div id = "navigationbar">
      <ul>
        <li><a class="active" href="#page">Home</a></li>
        <li><a href="#overview">Overview </a></li>
        <li><a href="#countryanalysis">General Analysis</a></li>
        <li><a href="#msaanalysis">MSA Level Analysis</a></li>
        <li><a href="#motivation">Motivation</a></li>
        <li><a href="#sources">Sources</a></li>
        <li class = "contact">
          <!-- Add Mail logo and link-->
          <a href="mailto:miguelperezrodriguez94@gmail.com" target="_blank"
          class="fa fa-envelope" 
          style="color:rgb(167, 46, 167)"></a>
        </li>
        <li class = "contact">
          <!-- Add GitHub logo and link-->
          <a href="https://github.com/miguelperez94"
          class="fa fa-github" 
          style="color:white"></a>
          </li>
        <li class = "contact">
          <!-- Add LinkedIn logo and link-->
          <a href="https://www.linkedin.com/in/miguelperezrodriguez94/" 
          class="fa fa-linkedin-square"
          style="color:#0072b1"></a>
          </li>
        <li class = "contact"><a style="background-color: #333">
          A page developed by Miguel Pérez Rodríguez
        </a></li>
      </ul>
    </div>

    <!-- Main page -->
    <div id="page" style="padding-top:20px;margin-top:30px;">

      <div id="header">
        <h1>A tool to analyze economic heterogeneity of 
          metropolitan areas in the United States</h1>
          <h2>
            Page developed by Miguel Pérez Rodríguez
            <!-- Add LinkedIn logo and link-->
            <!-- NOTE: I saw how to remove the underline in the link in this post of SheCodes
            Link: https://www.shecodes.io/athena/17496-how-to-remove-the-underline-of-a-link-in-css#:~:text=To%20remove%20the%20underline%20of%20a%20link%2C%20you%20can%20use,and%20set%20it%20to%20none%20.&text=This%20will%20remove%20the%20underline,line%2Dthrough%20%2C%20and%20blink%20. -->
            <a href="https://www.linkedin.com/in/miguelperezrodriguez94/" 
            class="fa fa-linkedin-square" 
            style="color:#0072b1"></a>
            <!-- Add GitHub logo and link-->
            <a href="https://github.com/miguelperez94"
            class="fa fa-github" 
            style="color:#333"></a>
            <!-- Add Mail logo and link-->
            <!-- NOTE: I saw how to add my mail into an href in the following post.
            Link: https://blog.hubspot.com/website/html-mailto -->
            <a href="mailto:miguelperezrodriguez94@gmail.com" target="_blank"
            class="fa fa-envelope" 
            style="color:purple"></a>
          </h2>
      </div>

      <div id="overview" class="contentTitle">
        <h1>Overview</h1>
      </div>

      <div class="contentText">
        <p>
          This webpage presents economic data for each Metropolitan Statistical 
          Area (MSA) in the United States in two ways: (i) an <strong>interactive map</strong> 
          that shows a general overview of heterogeneity in the United States by different 
          economic variables, and (ii) an <strong>interactive bar graph</strong> 
          that shows the percentile of the selected Metropolitan Area for each economic 
          variable in comparison to the other MSAs in the country.
        </p>
        <p>
          The economic variables available to analyze are (i) <strong>per capita 
          income</strong>, current levels and growth over time, (ii) 
          <strong>population</strong>, current levels and growth over time, and (iii) 
          <strong>general and housing regional price indices</strong>, current levels.
        </p>
      </div>

      <div id="countryanalysis" class="contentTitle">
        <h1>Economic Outlook of Metropolitan Areas in the United States at a Glance </h1>
      </div>

      <div class="contentText">
        Select minimum population (in millions) for Metropolitan Areas: 
          <select id="Button_min_population_map"></select> </br>
        Select attribute to analyze the Metropolitan Areas: 
          <select id="Button_attribute_map"></select> </br>
      </div>

      <div class="container">
        <div id="map"></div>
      </div>

      <div class="contentText tips">
        <strong>Tip 1</strong>: Hover over an MSA (colored areas) to see information about the 
        chosen economic variable for that area.<br/>
        <strong>Tip 2</strong>: With the mouse you can zoom and move around the map
        (for example, to see Alaska and Hawaii). 
      </div>

      <div id="msaanalysis" class="contentTitle">
        <h1>Economic Outlook of the selected Metropolitan Area </h1>
      </div>

      <div class="contentText">
        Select the FIPS code of the Metropolitan Area of your interest here: 
          <select id="Button_metro_area"></select> <br/>
      </div>
      <div class="contentText tips">
        <strong>Note</strong>: You can use the keyboard to select the area instead of using the mouse.
      </div>


      <div class="container">
        <div id="bar_chart"></div>
      </div>

      <div class="contentText tips">
        <strong>Tip 1</strong>: Hover over a bar related to a variable to see information about 
        that variable for the MSA and the US.<br/>
        <strong>Tip 2</strong>: If you don't know the FIPS code of the MSA of your interest, you can
        search it in the map above.
      </div>

      <div id="motivation" class="contentTitle">
        <h1>Motivation</h1>
      </div>

      <div class="contentText">
        <p>
          This webpage attempts to analyze economic heterogeneity in the United 
          States at the Metropolitan Statistical Area (MSA) level with two 
          questions that a user could have in mind: (i) "Where are things going 
          economically better and worse in the United States?", and (ii) 
          "How is a particular area doing in comparison to the rest of the United States?"
        </p>
        <p>
          Common approaches to do this type of analysis are at the County and State level, 
          the analysis at the MSA level presented here is an intermediate 
          level of analysis that is currently scarce and shows important
          economical differences across MSA in the country.
        </p>
        <p>
          By definition, each MSA has at least one urban core and includes
          adjacent communities having a high degree of economic and social integration.
          Also, MSAs have at least a population of 50,000 or more inhabitants. MSAs are
          defined periodically by the US government. Due to its characteristics, an analysis 
          at the MSA level can capture important trends in metropolitan economic activity
          that reflect actual economic relationships inside each area. 
        </p>
        <br />
        
        <p>
          As an interactive tool, the conclusions are up to the user, but overall, it is
          easy to see huge differences in almost every economic variable across the different MSA
          in the United States. Here are a couple of examples that I hope spark the curiosity
          of the reader:
        </p>
        <ul>
          <li>
            While the average personal income per capita in MSAs in the United States is USD 72k,
            there are MSAs with personal incomes as high as 145k and as low as 38k, with a median
            across MSAs of 59k. 
          </li>
          <li>
            While the average growth of the personal income per capita in MSAs in the United States 
            in the last 30 years is 215%, there are MSAs with personal incomes as 
            high as 507% and as low as 146%, with a median across MSAs of 206%.
          </li>
          <li>
            By construction the average housing price index in the United States is 100, 
            but there are MSAs with a housing index as high as 239 and as low as 51, 
            with a median across MSAs of 79.
          </li>
        </ul>
        <p>
          With these numbers in mind, I hope that you have developed some curiosity 
          about the topic, and that you enjoy exploring the data by yourself.
        </p>
      </div>

      <div class="contentTitle">
        <h1> Sources </h1>
      </div>

      <div id="sources" class="contentText">
        <li>
          <a href="https://apps.bea.gov/itable/?ReqID=70&step=1&_gl=1*1hajvqr*_ga*NDk0MDAwMTYxLjE3MzI5MDY3NzA.*_ga_J4698JNNFT*MTczMzcwMTUzNS42LjEuMTczMzcwMTc0MC41MS4wLjA.">
          U.S. Bureau of Economic Analysis (BEA) - Regional Data</a>: 
          Economic data at the MSA level related to population, personal income per capita, 
          and general and housing price indices.
        </li>
        <li>
          <a href="https://www.jsdelivr.com">
          jsDelivr Open Source maps</a>: 
          TopoJson maps related to (i) 
          <a href = "https://www.jsdelivr.com/package/npm/world-atlas">countries of the world</a> 
          and (ii) <a href = "https://www.jsdelivr.com/package/npm/us-atlas">
          states in the United States</a>.
        </li>
        <li>
          <a href="https://github.com/loganpowell/census-geojson/tree/master/GeoJSON/20m/2021">
          Logal Powell GitHub</a>: 
          GeoJson map related to Metropolitan Statistical Areas in the United States.
        </li>
        <li><a href="https://www.census.gov/programs-surveys/metro-micro/about.html">
          United States Census Bureau</a>: 
          Formal definition of Metropolitan Statistical Area.
        </li>
        <li><a href="https://www.bryantsmith.com/template/">
          Bryant Smith CSS Templates - Reverted Template </a>: 
          Part of CSS structure for this webpage.
        </li>
        <li><a href="https://www.w3schools.com/css/css_navbar_horizontal.asp">
          W3Schools - CSS Navigation Bar Guidelines</a>: 
          Guidelines for CSS code related to Navigation Bars.
        </li>
      </div>

    </div>

    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://unpkg.com/topojson@3"></script>
    <script>

      d3.json("visualization_dataset.json?a").then(function(data) {
        whole_dataset = data;
      });

      const width = 800;
      const height = 600;
      const svg_map = d3
        .select("#map")
        .append("svg")
        .attr("viewBox", [0, 0, width, height])
        .attr("width", width/1.25)
        .attr("height", height/1.25);

      const bar_graph = d3
          .select("#bar_chart")
          .append("svg")
          .attr("viewBox", [0, 0, width/2, height/2.1])
          .attr("width", width)
          .attr("height", height/1.3);

      // auxiliar function to convert dictionaries to arrays, used for map data
      // NOTE: I get this function from this GeekforGeeks post
      // Link: https://www.geeksforgeeks.org/convert-dictionary-into-an-array-of-objects-in-javascript/#
      const dictionaryToArrayOfObjects = (dictionary) => {
            return Object.keys(dictionary).map(key => ({
                key: key,
                value: dictionary[key]
            }));
        };

      // auxiliar function to format the numbers
      // NOTE: I saw how to use Intl.NumberFormat in this MDN link, "Try it" section.
      // Link: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Intl/NumberFormat
      function formatnumber(number, digits = 3) {
          return new Intl.NumberFormat('en-US', { maximumSignificantDigits: digits }).format(number);
        }

      // d3 tooltip pattern: create a placeholder div which will be
      // hidden at first & revealed/moved as needed
      const tooltip = d3
        .select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      // set up projection centered on the United States
      const projection = d3
        .geoMercator()
        .center([-103.462, 44.582])
        .scale(525)
        .translate([width / 2, height / 2]);
      const path = d3.geoPath().projection(projection);

      // Group to be able to do zoom in the map
      // NOTE: I saw an example code of how to do zoom in d3 v7 in this GitHub Gist post
      // Link: https://gist.github.com/d3noob/7b7e98331f440139dff50f4a58044677
      var g = svg_map.append("g");

      // load TopoJSON countries
      d3.json(
        "https://cdn.jsdelivr.net/npm/world-atlas@2/countries-50m.json",
      ).then((data_countries) => {
        // load topojson as geojson
        const geojson_countries = topojson.feature(data_countries, data_countries.objects.countries);
        const countries = geojson_countries.features;

        // add countries to map
        g
          .selectAll(".countries")
          .data(countries)
          .join("path")
          .attr("d", path)
          .attr("fill", "#f2f2f2")
          .attr("stroke", "black")
          .attr("stroke-width", 1);

        // load TopoJSON states
        d3.json(
          "https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json",
        ).then((data_states) => {
          // load topojson as geojson
          const geojson_states = topojson.feature(data_states, data_states.objects.states);
          const states = geojson_states.features;

          // add states to map
          g
            .selectAll(".states")
            .data(states)
            .join("path")
            .attr("d", path)
            .attr("fill", "#fcfbfd")
            .attr("stroke", "gray")
            .attr("stroke-width", .3);
        });
      });

      // Groups available for minimum population criteria for map button
      // NOTE: I saw the structure for this button functionality from this post of 
      // D3.js Graph Gallery
      // Link: https://d3-graph-gallery.com/graph/connectedscatter_select.html
      const population_options =["0.05", "0.1", "0.25", "0.5", "1.0", "1.5", "2.0", "5.0", "10.0"]

      // add the options to the minimum population button
      d3.select("#Button_min_population_map")
        .selectAll('pop_options')
        .data(population_options)
        .enter()
        .append('option')
        .text(function (d) { return d; })
        .attr("value", function (d) { return d; });

      // Groups available for attribute criteria for map button
      const attribute_options =[
        "Per Capita Income (USD Thousands)",
        "General Regional Price Parity Index",
        "Housing Regional Price Parity Index",
        "Population Growth Last 5 Years (%)",
        "Population Growth Last 10 Years (%)",
        "Per Capita Income Growth Last Year (%)",
        "Per Capita Income Growth Last 5 Years (%)",
        "Per Capita Income Growth Last 10 Years (%)",
        "Per Capita Income Growth Last 20 Years (%)",
        "Per Capita Income Growth Last 30 Years (%)",
      ]

      // add the options to the attribute button
      d3.select("#Button_attribute_map")
        .selectAll('attr_options')
        .data(attribute_options)
        .enter()
        .append('option')
        .text(function (d) { return d; })
        .attr("value", function (d) { return d; });

      // load TopoJSON metropolitan areas
      const metropilitan_areas_url = "https://raw.githubusercontent.com/loganpowell/census-geojson/refs/heads/master/GeoJSON/20m/2021/metropolitan-statistical-area!micropolitan-statistical-area.json";
      d3.json(
        metropilitan_areas_url,
      ).then((data) => {
        d3.json("visualization_dataset.json?m").then(function(whole_dataset) {
          
          /*
          THIS PART IS ONLY DATA MANIPULATION FOR THE USE OF THE DATASET
          */

          // generate new reduced datasets and medians according to variables to use
          // NOTE: I saw how to do a reduced json based in a bigger json in the first answer of 
          // this StackOverflow link
          // Link: https://stackoverflow.com/questions/34010342/map-and-reduce-json-objects-with-javascript
          const metro_area_name_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.GeoName.replace(
              " (Metropolitan Statistical Area)", "").replace(" *", "");
            return pv;
          }, {});

          const population_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.Population[2023]/10**6;
            return pv;
          }, {});

          const per_capita_income_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.PerCapitaIncome[2023]/10**3;
            return pv;
          }, {});

          const median_per_capita_income = d3.median(
            dictionaryToArrayOfObjects(per_capita_income_map), d => d.value);
          
          const general_price_index_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.GeneralPriceIndex["Value"];
            return pv;
          }, {});

          const median_general_price_index = d3.median(
            dictionaryToArrayOfObjects(general_price_index_map), d => d.value);

          const housing_price_index_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.HousingPriceIndex["Value"];
            return pv;
          }, {});

          const median_housing_price_index = d3.median(
            dictionaryToArrayOfObjects(housing_price_index_map), d => d.value);

          const population_change_5_years_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = ((1 + cv.PopulationChange5Years["Value"]/100)**5 - 1)*100;
            return pv;
          }, {});

          const median_population_change_5_years = d3.median(
            dictionaryToArrayOfObjects(population_change_5_years_map), d => d.value);

          const population_change_10_years_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = ((1 + parseFloat(cv.PopulationChange10Years["Value"])/100)**10 - 1)*100;
            return pv;
          }, {});

          const median_population_change_10_years = d3.median(
            dictionaryToArrayOfObjects(population_change_10_years_map), d => d.value);

          const per_capita_income_change_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.PerCapitaIncomeChange[2023];
            return pv;
          }, {});

          const median_per_capita_income_change = d3.median(
            dictionaryToArrayOfObjects(per_capita_income_change_map), d => d.value);

          const per_capita_income_change_5_years_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = ((1 + cv.PerCapitaIncomeChange5Years["Value"]/100)**5 - 1)*100;
            return pv;
          }, {});
        
          const median_per_capita_income_change_5_years = d3.median(
            dictionaryToArrayOfObjects(per_capita_income_change_5_years_map), d => d.value);

          const per_capita_income_change_10_years_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = ((1 + cv.PerCapitaIncomeChange10Years["Value"]/100)**10 - 1)*100;
            return pv;
          }, {});

          const median_per_capita_income_change_10_years = d3.median(
            dictionaryToArrayOfObjects(per_capita_income_change_10_years_map), d => d.value);

          const per_capita_income_change_20_years_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = ((1 + cv.PerCapitaIncomeChange20Years["Value"]/100)**20 - 1)*100;
            return pv;
          }, {});

          const median_per_capita_income_change_20_years = d3.median(
            dictionaryToArrayOfObjects(per_capita_income_change_20_years_map), d => d.value);

          const per_capita_income_change_30_years_map = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = ((1 + cv.PerCapitaIncomeChange30Years["Value"]/100)**30 - 1)*100;
            return pv;
          }, {});

          const median_per_capita_income_change_30_years = d3.median(
            dictionaryToArrayOfObjects(per_capita_income_change_30_years_map), d => d.value);

          // datasets for percentile data
          const per_capita_income_percentile = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.PerCapitaIncomePercentile["Value"];
            return pv;
          }, {});

          // datasets for percentile data
          const general_price_index_percentile = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.GeneralPriceIndexPercentile["Value"];
            return pv;
          }, {});

          // datasets for percentile data
          const housing_price_index_percentile = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.HousingPriceIndexPercentile["Value"];
            return pv;
          }, {});

          const population_change_5_years_percentile = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.PopulationChange5YearsPercentile["Value"];
            return pv;
          }, {});

          const population_change_10_years_percentile = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.PopulationChange10YearsPercentile["Value"];
            return pv;
          }, {});

          const per_capita_income_change_percentile = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.PerCapitaIncomeChangePercentile["Value"];
            return pv;
          }, {});

          const per_capita_income_change_5_years_percentile = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.PerCapitaIncomeChange5YearsPercentile["Value"];
            return pv;
          }, {});

          const per_capita_income_change_10_years_percentile = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.PerCapitaIncomeChange10YearsPercentile["Value"];
            return pv;
          }, {});

          const per_capita_income_change_20_years_percentile = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.PerCapitaIncomeChange20YearsPercentile["Value"];
            return pv;
          }, {});

          const per_capita_income_change_30_years_percentile = whole_dataset.reduce(function(pv, cv) {
            pv[cv.GeoFips] = cv.PerCapitaIncomeChange30YearsPercentile["Value"];
            return pv;
          }, {});

          
          // Dictionary of equivalence between attribute options and name of the variable for map
          const attribute_options_dict = {
            "Per Capita Income (USD Thousands)" : per_capita_income_map,
            "General Regional Price Parity Index" : general_price_index_map,
            "Housing Regional Price Parity Index" : housing_price_index_map,
            "Population Growth Last 5 Years (%)" : population_change_5_years_map,
            "Population Growth Last 10 Years (%)" : population_change_10_years_map,
            "Per Capita Income Growth Last Year (%)" : per_capita_income_change_map,
            "Per Capita Income Growth Last 5 Years (%)" : per_capita_income_change_5_years_map,
            "Per Capita Income Growth Last 10 Years (%)" : per_capita_income_change_10_years_map,
            "Per Capita Income Growth Last 20 Years (%)": per_capita_income_change_20_years_map,
            "Per Capita Income Growth Last 30 Years (%)" : per_capita_income_change_30_years_map,
          }

          // Dictionary of equivalence between attribute options and name of the variable for graph
          const attribute_options_graph_dict = {
            "Per Capita Income" : 
              ["Per Capita Income (USD Thousands)", 
              per_capita_income_map, 
              median_per_capita_income],
            "General Regional Price Parity Index":
              ["General Regional Price Parity Index",
              general_price_index_map,
              median_general_price_index],
            "Housing Regional Price Parity Index":
              ["Housing Regional Price Parity Index",
              housing_price_index_map,
              median_housing_price_index],
            "Population Growth Last 5 Years" : 
              ["Population Growth Last 5 Years (%)", 
              population_change_5_years_map, 
              median_population_change_5_years],
            "Population Growth Last 10 Years" : 
              ["Population Growth Last 10 Years (%)", 
              population_change_10_years_map, 
              median_population_change_10_years],
            "Per Capita Income Growth Last Year" : 
              ["Per Capita Income Growth Last Year (%)", 
              per_capita_income_change_map, 
              median_per_capita_income_change],
            "Per Capita Income Growth Last 5 Years" : 
              ["Per Capita Income Growth Last 5 Years (%)", 
              per_capita_income_change_5_years_map,
              median_per_capita_income_change_5_years],
            "Per Capita Income Growth Last 10 Years" : 
              ["Per Capita Income Growth Last 10 Years (%)", 
              per_capita_income_change_10_years_map, 
              median_per_capita_income_change_10_years],
            "Per Capita Income Growth Last 20 Years": 
              ["Per Capita Income Growth Last 20 Years (%)", 
              per_capita_income_change_20_years_map,
              median_per_capita_income_change_20_years],
            "Per Capita Income Growth Last 30 Years" : 
              ["Per Capita Income Growth Last 30 Years (%)", 
              per_capita_income_change_30_years_map,
              median_per_capita_income_change_30_years],
          }

          /*
          HERE IS THE CODE FOR THE MAP
          */

          function update_map (defined_min_population, defined_attribute, name_of_attribute) {
            // define variable for scale and colors
            const scale_variable = defined_attribute
            const scale_map = dictionaryToArrayOfObjects(scale_variable);

            // color function used for choropleth
            const colorScale = d3
              .scaleSequential()
              .domain([
                d3.quantile(scale_map, 0.995, function(d) { return +d.value; }), 
                d3.quantile(scale_map, 0.01, function(d) { return +d.value; })
              ]) // Reversed domain so higher numbers are darker
              .interpolator(d3.interpolateViridis);

            // Get only metro areas that has population over the defined threshold
            const metropolitan_areas_map = data.features.filter(
            (d) => population_map[d.properties.GEOID] >= defined_min_population,
            );

            // erase previous metro areas in the map
            g.selectAll('.metropolitan_areas').remove();
            g.selectAll('.metro-area-path').remove();
            svg_map.selectAll('.legend').remove();

            // add metro areas to the map
            g
              .selectAll(".metropolitan_areas")
              .data(metropolitan_areas_map)
              .join("path")
              .attr("class", "metro-area-path")
              .attr("d", path)
              .attr("fill", (d) => {
                let score = scale_variable[d.properties.GEOID];
                return score ? colorScale(score) : "#ccc";
              })
              .attr("stroke", "blue")
              .attr("stroke-width", 0.4)
              // Mouseover effect for having information of the selected metro area with mouse
              .on("mouseover", function (event, d) {
                tooltip.transition().duration(200).style("opacity", 0.9);
                tooltip
                  .html(
                    `
                  <strong>${d.properties.NAME}</strong><br/>
                  FIPS Code Metropolitan Area: ${d.properties.GEOID}<br/>
                  Population (millions): ${formatnumber(population_map[d.properties.GEOID])}<br/>
                  ${name_of_attribute}: ${formatnumber(scale_variable[d.properties.GEOID])}<br/>
                `
                ,
                  )
                  .style("left", event.pageX + 10 + "px")
                  .style("top", event.pageY - 28 + "px");
              })
              .on("mouseout", function () {
                tooltip.transition().duration(500).style("opacity", 0);
              });


            // legend for color scale
            const legendWidth = 200;
            const legendHeight = 20;
            const legendScale = d3
              .scaleLinear()
              .domain([
                d3.min(scale_map, function(d) { return +d.value; }), 
                d3.max(scale_map, function(d) { return +d.value; })])
              .range([0, legendWidth]);

            const legendAxis = d3
              .axisBottom(legendScale)
              .ticks(8)
              .tickFormat((d) => d);

            const legend = svg_map
              .append("g")
              .attr("class", "legend")
              .attr(
                "transform",
                `translate(${20}, ${height - 50})`,
              );

            const defs = svg_map.append("defs");
            const gradient = defs
              .append("linearGradient")
              .attr("class", "legend")
              .attr("id", "legend-gradient")
              .attr("x1", "0%")
              .attr("x2", "100%")
              .attr("y1", "0%")
              .attr("y2", "0%");

            // Add gradient stops
            const stops = d3.range(
              d3.min(scale_map, function(d) { return +d.value; }), 
              d3.max(scale_map, function(d) { return +d.value; })
            );

            stops.forEach((stop, i) => {
              gradient
                .append("stop")
                .attr("class", "legend")
                .attr("offset", `${(i / (stops.length - 1)) * 100}%`)
                .attr("stop-color", colorScale(stop));
            });

            legend
              .append("rect")
              .attr("class", "legend")
              .attr("width", legendWidth)
              .attr("height", legendHeight)
              .style("fill", "url(#legend-gradient)");

            legend
              .append("g")
              .attr("class", "legend")
              .attr("transform", `translate(0, ${legendHeight})`)
              .call(legendAxis);
          }

          // auxliar variables for changing parameters of population and attribute
          let selected_population_now = "0.05";
          let name_selected_attribute_now = "Per Capita Income (USD Thousands)";
          let selected_attribute_now = attribute_options_dict[name_selected_attribute_now];

          // initialize map with a predefined minimum population and attribute
          update_map(selected_population_now, selected_attribute_now, name_selected_attribute_now);

          // list to the slider to change map based on the new minimum population
          d3.select("#Button_min_population_map").on("change", function(d){
            selected_population_now = this.value
            update_map(selected_population_now, selected_attribute_now, name_selected_attribute_now);
            svg_map.call(zoom.transform, d3.zoomTransform(svg_map.node()));
          });

          // list to the slider to change map based on the new attribute
          d3.select("#Button_attribute_map").on("change", function(d){
            name_selected_attribute_now = this.value
            selected_attribute_now = attribute_options_dict[this.value]
            update_map(selected_population_now, selected_attribute_now, name_selected_attribute_now);
            svg_map.call(zoom.transform, d3.zoomTransform(svg_map.node()));
          });

          /*
          HERE IS THE CODE FOR THE BAR GRAPH
          */

          // Metropolitan areas available for fips code for graph button
          const metro_area_options = Object.keys(metro_area_name_map);

          // add options to the metropolitan area button
          d3.select("#Button_metro_area")
            .selectAll('metropolitan_area_options')
            .data(metro_area_options)
            .enter()
            .append('option')
            .text(function (d) { return d; })
            .attr("value", function (d) { return d; });

          // generate percentile Scale for bar graph
          const percentileScale = d3
          .scaleLinear()
          .domain([0, 100])
          .range([0, 200]);

          // generate attribute names for bar graph
          let bar_graph_attributes = []
          bar_graph_attributes.push(
              "Per Capita Income", 
              "General Regional Price Parity Index",
              "Housing Regional Price Parity Index",
              "Population Growth Last 5 Years",
              "Population Growth Last 10 Years",
              "Per Capita Income Growth Last Year",
              "Per Capita Income Growth Last 5 Years",
              "Per Capita Income Growth Last 10 Years",
              "Per Capita Income Growth Last 20 Years",
              "Per Capita Income Growth Last 30 Years"
            )
          
          // function to create bar graph
          function update_graph(selected_fips_code) {
            // assign varibale for fips code
            const fips_code = selected_fips_code

            // erase previous text related to last selected metropolitan area
            bar_graph.selectAll("text").remove();

            // add percentile data for graph
            let bar_graph_data = []
            bar_graph_data.push(
              parseFloat(per_capita_income_percentile[fips_code]),
              parseFloat(general_price_index_percentile[fips_code]),
              parseFloat(housing_price_index_percentile[fips_code]),
              parseFloat(population_change_5_years_percentile[fips_code]),
              parseFloat(population_change_10_years_percentile[fips_code]),
              parseFloat(per_capita_income_change_percentile[fips_code]),
              parseFloat(per_capita_income_change_5_years_percentile[fips_code]),
              parseFloat(per_capita_income_change_10_years_percentile[fips_code]),
              parseFloat(per_capita_income_change_20_years_percentile[fips_code]),
              parseFloat(per_capita_income_change_30_years_percentile[fips_code])
            )

            // header of the graph
            // NOTE: I saw how to use length in D3 in this post of MDN
            // Link: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String/length
            let space_for_header = 50;
            let metro_area_name_width = metro_area_name_map[fips_code].length
            bar_graph
              .append("text")
              .attr("y", 20)
              .attr("x", width/8 - metro_area_name_width*1.5)
              .attr("class", "graph_title")
              .style("fill", "White")
              .style("font-size", "11px")
              .text(`Percentile stats for: ${metro_area_name_map[fips_code]}`);

            // subtitle of the graph
            bar_graph
              .append("text")
              .attr("y", 33)
              .attr("x", width/12)
              .attr("class", "graph_title")
              .style("fill", "White")
              .style("font-size", "7px")
              .text(`(Percentile of the selected MSA in comparison to all MSAs in the US)`);

            // join rectangles
            bar_graph.selectAll("rect")
              .data(bar_graph_data)
              .join("rect")
              .attr("class", (d, i) => `class_${i}`)
              .attr("id", (d, i) => `${bar_graph_attributes[i]}`)
              .attr("x", width/4)
              .attr("y", (d, i) => space_for_header + i * 20)
              .attr("width", (d) => 2*d)
              .attr("height", 15)
              .style("fill", "LightSteelBlue")
              .on("mouseover", onHover)
              .on("mouseout", offHover);

            // join text of attribute
            bar_graph.selectAll("text.attribute")
              .data(bar_graph_attributes)
              .join("text")
              .attr("class", (d, i) => `class_${i}`)
              .attr("x", 2)
              .attr("y", (d, i) => space_for_header + 10 + i * 20)
              .style("fill", "White")
              .style("font-size", "8px")
              .text((d, i) => d);

            // Add the X axis of the percentile graph
            const axis = d3.axisBottom(percentileScale).ticks(3);
            bar_graph
              .append("g")
              .attr(
                "transform",
                `translate(${width/4}, ${space_for_header + bar_graph_data.length * 20})`
              )
              .call(axis)
              .style("font-size", "8px");

            // Add label to the axis
            bar_graph
              .append("text")
              .attr("x", width/3.5)
              .attr("y", space_for_header + bar_graph_data.length * 20 + 25)
              .text("Percentile of the Metropolitan Area")
              .style("fill", "White")
              .style("font-size", "8px");
            
            // Add text related to specific percentile for each attribute
            bar_graph.selectAll("text.percentile")
              .data(bar_graph_data)
              .join("text")
              .attr("x", (d) => width/4 + 2*d + 5)
              .attr("y", (d, i) => space_for_header + 10 + i * 20)
              .attr("class", (d, i) => `class_${i} percentile_number`)
              .style("fill", "White")
              .style("font-size", "8px")
              .text((d, i) => formatnumber(d, 2));
          };

        // initialize the graph with a predefined fips code for metropolitan area
        let current_fips_code = "16980";
        // AI NOTE: For the following line I asked to ChatGPT "I want to put a predefined value to
        // a button in HTML with JavaScript", this line is the modified code related to that answer
        document.getElementById("Button_metro_area").value = "16980";
        update_graph(current_fips_code);

        // list to the slider to change graph based on the new fips code
        d3.select("#Button_metro_area").on("change", function(d){
          current_fips_code = this.value
          update_graph(current_fips_code);
        })

        /*
        THIS PART ADDS (i) MOUSEOVER AND MOUSEOUT EFFECTS FOR BAR GRAPH, AND 
        (ii) ZOOM EFFECT FOR THE MAP
        */

        // Add mouseover (with tooltip) and mouseout hover effects to graph
        // NOTE: I saw how to do mouseover and mouseout effects in the D3 homework of the class
        function onHover(d, i) {
          // get the element where the event occurred
          let selection = d3.select(this);
          // get the class related to that element
          let class_of_selection = selection.attr("class");
          // set the changes in style for the entire class
          d3.selectAll("rect." + class_of_selection)
            .style("fill", "#E5E2E0");
          d3.selectAll("text." + class_of_selection)
            .style("fill", "#E5E2E0")
            .style("font-size", "9.5px");
          // add tooltip for each rectangle related to a variable of the graph
          tooltip.transition().duration(200).style("opacity", 0.9);
          let tooltip_helper = attribute_options_graph_dict[selection.attr("id")]
          tooltip.html(
            `
            <strong>${tooltip_helper[0]}</strong>
            <br/>
            Selected Metropolitan Area: 
            ${formatnumber(tooltip_helper[1][current_fips_code])}
            <br/>
            United States Avg. (Metropolitan Areas): 
            ${formatnumber(tooltip_helper[1]["00998"])}
            <br/>
            United States Median (Metropolitan Areas): 
            ${formatnumber(tooltip_helper[2])}
            <br/>
            `
            ,
            )
            .style("left", event.pageX + 10 + "px")
            .style("top", event.pageY - 63 + "px");
        };

        function offHover(d, i) {
          // get the element where the event occurred
          let selection = d3.select(this);
          // get the class related to that element
          let class_of_selection = selection.attr("class");
          // set the come back to normal style for the entire class
          d3.selectAll("rect." + class_of_selection)
            .style("fill", "LightSteelBlue");
          d3.selectAll("text." + class_of_selection)
            .style("fill", "white")
            .style("font-size", "8px");
          // erase tooltip with informative text for the attribute
          tooltip.transition().duration(500).style("opacity", 0);
        };
        
        });
      });
      
      // Add zoom for interactivity
      // NOTE: I saw an example code of how to do zoom in d3 v7 in this GitHub Gist post
      // Link: https://gist.github.com/d3noob/7b7e98331f440139dff50f4a58044677
      const zoom = d3.zoom()
        .scaleExtent([1, 8])
        .on('zoom', function(event) {
            g.selectAll('path')
            .attr('transform', event.transform);
      });
      svg_map.call(zoom);
  
    </script>
  
  </body>

</html>
